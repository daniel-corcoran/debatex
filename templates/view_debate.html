{% extends 'base.html' %}
{% block content %}
<script src="static/vis-network.min.js"></script>
    <style>
    #content {
        display: flex;
        height: 90%;
        margin-top: 2em;
    }
    #editor {
        width: 39%;
        border: solid 2px black;
        text-align: center;
        background: white;
         border-radius: 1em;
    }
    #graph {
        width: 60%;
        border: solid 2px black;
        background: white;

        border-radius: 1em;
        text-align: center;

    }
    #edit_text {
        width: 99%;
        height: 15em;
        border: solid 1px black;
    }


    </style>
<div id="content">
<div id="graph">
    <h1>{{ title }}</h1>
    <div id="graph_container"></div>
    <!-- Graph goes here -->
</div>

<div id="editor">
    <!-- Editor. user must be logged in -->
    <p style="color: blue">{{ msg }}</p>
    {% if user.logged_in %}
    <h1>Add Premise</h1>
    <p>Type in here a new premise to support one of the premises seen here.</p>
    <p>Please write a premise that is distinct from any existing premises, and keep it concise. </p>
    <form action="/add_premise" method="POST">
    <textarea id="edit_text" name="premise"></textarea><br>
    <input type="hidden" name="debate_id" value = {{ debate_id }}>
    <input type="submit" value="Submit">
    </form>

    <hr>

    <form action="/add_connection" method="post">

    <h1>Connect Premises</h1>
    <p>Define a connection between two premises that either support, refute or contradict each other.</p>

    <select name="connectionto" id="connectionto">
    {%  for node in nodes %}
    <option value="{{ node.id }}">{{ node.label }}</option>
    {% endfor %}
    </select>
    <select name="connectiontype" id="connectiontype">
        <option value="support">Supports</option>
        <option value="refute">Refutes</option>
        <option value="contradict">Contradicts</option>
    </select>
    <select name="connectionfrom" id="connectionfrom">
    {%  for node in nodes %}
    <option value="{{ node.id }}">{{ node.label }}</option>
    {% endfor %}    </select>

    <input type="hidden" name="debate_id" value = {{ debate_id }}>
    <input type="submit" value="Connect">
    </form>

    <hr>
        <div id="vote_node"hidden>
            <h3>Vote on premise: <span id="premise_id"></span></h3>
            <button action="like_selection()">Like</button>
            <button action="dislike_selection()">Dislike</button>
            <p>Current like-dislike ratio: <span id="node_like_ratio"></span></p>
        </div>
        <div id="vote_edge" hidden>
            <h3>Vote on connection: <span id="connection_id"></span></h3>
            <button action="like_selection()">Like</button>
            <button action="dislike_selection()">Dislike</button>
        <p>Current like-dislike ratio: <span id="edge_like_ratio"></span></p>
        </div>
    {% if user.name == 'daniel' %}
        <hr>
        <form action="/delete_edge" method="post">
            <h1>Delete Edge</h1>
            <input type="text" name="delete_edge" id="delete_edge" placeholder="Click an edge to delete">
            <input type="hidden" name="debate_id" value = {{ debate_id }}>
            <input type="submit" value="Delete"></input>
        </form>
        <hr>
        <form action="/delete_node" method="post">
            <h1>Delete node</h1>
            <input type="text" name="delete_node" id="delete_node" placeholder="Click an node to delete">
            <input type="hidden" name="debate_id" value = {{ debate_id }}>
            <input type="submit" value="Delete"></input>
        </form>
    {% endif %}
    {% else %}
    <h2>Log in to add your own views and connections to this debate!</h2>
    {% endif %}


</div>

<script>

      // create an array with nodes
      var nodes = new vis.DataSet([
          {% for node in nodes %}
             { id: {{ node.id }}, label: "{{node.label}}", shape: 'box', widthConstraint: { maximum: 250 }},
          {% endfor %}


      ]);

      // create an array with edges
      var edges = new vis.DataSet([
          {% for edge in edges %}
             { from: {{ edge.from }},
                 to: {{ edge.to }},
                 arrows: "{{ edge.arrow }}",
                 color: {{ edge.color | safe }},
                 label: "{{ edge.label }}",
                 id: {{ edge.id }} },
          {% endfor %}
      ]);

      // create a network
      var container = document.getElementById("graph_container");
      var data = {
        nodes: nodes,
        edges: edges,
      };
    var options = {
      "physics": {
        "barnesHut": {
          "springConstant": 0.01,
          "avoidOverlap": 0.1
        }
      }
    }

  var network = new vis.Network(container, data, options);

        network.on( 'click', function(properties) {
            console.log(properties)
            if(properties.nodes.length > 0){
                // User selected a node
                console.log("Node", properties.nodes, nodes.get(properties.nodes))
                document.getElementById('delete_node').value = nodes.get(properties.nodes)[0].id
                document.getElementById('vote_node').removeAttribute("hidden")
                document.getElementById('vote_edge').setAttribute("hidden", '')
                document.getElementById('premise_id').innerText = nodes.get(properties.nodes)[0].id

            }else if( properties.items.length > 0 ){
                // User selected an edge
                edge_id = edges.get(properties.items[0].edgeId).id
                console.log("edge", edges.get(properties.items[0].edgeId).id)
                document.getElementById('delete_edge').value = edges.get(properties.items[0].edgeId).id
                document.getElementById('vote_edge').removeAttribute("hidden")
                document.getElementById('vote_node').setAttribute("hidden", '')
                document.getElementById("connection_id").innerText = edges.get(properties.items[0].edgeId).id
            }
    });



</script>


</div>
{% endblock %}